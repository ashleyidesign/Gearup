<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GearUp — What Should I Wear?</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="app" id="app">
  <div class="header"><div class="logo"><span>⚙️</span> GearUp</div></div>
  <div class="loading-state"><div class="loader"></div><div class="loading-text">Loading weather + gear…</div></div>
</div>
<script>
// ============================================================
// WORKOUT PARSER MODULE
// ============================================================
var ACTIVITY_MAP = {
  'running':'running','cycling':'cycling','strength':'strength',
  'swimming':'swimming','hiking':'hiking','walking':'walking',
  'running_subtypes': {
    'uphill ski':'uphill_skiing','xc ski':'xc_skiing','cross country':'xc_skiing',
    'trail':'trail_running','road':'road_running','snowshoe':'snowshoeing',
    'walk':'walking','hike':'hiking',
  },
  'cycling_subtypes': {
    'fat bike':'fat_biking','fatbike':'fat_biking','stud':'stud_biking',
    'mountain':'mountain_biking','mtb':'mountain_biking',
    'road':'road_cycling','gravel':'road_cycling',
  }
};
var PARSER_TO_GEAR_KEY = {
  'uphill_skiing':'uphill-ski','xc_skiing':'xc-ski','downhill_skiing':'downhill-ski',
  'road_running':'run-road','trail_running':'run-trail','running':'run-road',
  'road_cycling':'road-bike','mountain_biking':'mtb','fat_biking':'fat-bike',
  'stud_biking':'stud-bike','cycling':'road-bike','hiking':'hike',
  'snowshoeing':'snowshoe','walking':'dog-walk','dog_walk':'dog-walk',
  'snowmobile':'snowmobile','dirt_bike':'dirtbike','motorcycle':'dirtbike',
};
function parseSummary(summary) {
  var ci = summary.indexOf(':');
  if (ci === -1) return { sport:'unknown', workoutName:summary };
  var sport = summary.substring(0, ci).toLowerCase().trim();
  var name = summary.substring(ci + 1).trim();
  if (name.length >= 2) {
    for (var len = Math.ceil(name.length / 2); len < name.length; len++) {
      var c = name.substring(0, len);
      if (name === c + c || name.startsWith(c + c)) { name = c; break; }
    }
  }
  return { sport: sport, workoutName: name.trim() };
}
function resolveActivityType(sport, workoutName) {
  var nl = workoutName.toLowerCase();
  var sk = sport + '_subtypes';
  if (ACTIVITY_MAP[sk]) { for (var kw in ACTIVITY_MAP[sk]) { if (nl.includes(kw)) return ACTIVITY_MAP[sk][kw]; } }
  return ACTIVITY_MAP[sport] || sport;
}
function parseDuration(s) {
  var m = 0;
  var hr = s.match(/(\d+)\s*hr/i), mn = s.match(/(\d+)\s*min/i), sc = s.match(/(\d+)\s*sec/i);
  if (hr) m += parseInt(hr[1]) * 60; if (mn) m += parseInt(mn[1]); if (sc) m += parseInt(sc[1]) / 60;
  return Math.round(m);
}
function parseDescription(desc) {
  if (!desc) return {};
  var lines = desc.split('\n');
  var r = { sport:null, totalDistance:null, totalDuration:null, elevation:null, intervals:[], humanGoLink:null };
  for (var i = 0; i < lines.length; i++) {
    var t = lines[i].trim();
    if (t.startsWith('sport:')) r.sport = t.replace('sport:','').trim();
    else if (t.startsWith('total distance:')) { var dm = t.match(/([\d.]+)\s*miles/i); r.totalDistance = dm ? parseFloat(dm[1]) : null; }
    else if (t.startsWith('total duration:')) r.totalDuration = parseDuration(t.replace('total duration:','').trim());
    else if (t.startsWith('Elevation:')) r.elevation = t.replace('Elevation:','').trim();
    else if (t.startsWith('View on HumanGo:')) r.humanGoLink = t.replace('View on HumanGo:','').trim();
  }
  var sections = desc.split(/={10,}/);
  for (var si = 0; si < sections.length; si++) {
    var sl = sections[si].trim().split('\n').map(function(l){return l.trim();}).filter(function(l){return l;});
    if (!sl.length) continue;
    var type = sl[0].toLowerCase();
    if (['warmup','interval','recovery','cooldown'].indexOf(type) !== -1) {
      var iv = { type: type };
      for (var li = 1; li < sl.length; li++) {
        var line = sl[li];
        if (line.startsWith('duration:')) iv.duration = parseDuration(line.replace('duration:',''));
        else if (line.startsWith('heart rate:')) iv.hrZone = {};
        else if (line.startsWith('low:') && iv.hrZone) { var lm = line.match(/(\d+)\s*bpm/i); if (lm) iv.hrZone.low = parseInt(lm[1]); }
        else if (line.startsWith('high:') && iv.hrZone) { var hm = line.match(/(\d+)\s*bpm/i); if (hm) iv.hrZone.high = parseInt(hm[1]); }
      }
      r.intervals.push(iv);
    }
  }
  return r;
}
function estimateIntensity(pd) {
  var ivs = pd.intervals || [];
  if (!ivs.length) return 'moderate';
  var maxHR = 0;
  for (var i = 0; i < ivs.length; i++) { if (ivs[i].hrZone && ivs[i].hrZone.high) maxHR = Math.max(maxHR, ivs[i].hrZone.high); }
  if (maxHR >= 158) return 'hard';
  if (maxHR >= 130) return 'moderate';
  return 'easy';
}
function convertEventTime(dts, tz) {
  tz = tz || 'America/New_York';
  var d = new Date(dts);
  return {
    date: d.toLocaleDateString('en-US', { timeZone:tz, weekday:'short', month:'short', day:'numeric' }),
    time: d.toLocaleTimeString('en-US', { timeZone:tz, hour:'numeric', minute:'2-digit' }),
    hour: parseInt(d.toLocaleString('en-US', { timeZone:tz, hour:'numeric', hour12:false })),
    localDate: d.toLocaleDateString('en-CA', { timeZone:tz }),
  };
}
function parseWorkoutEvent(event) {
  var ps = parseSummary(event.summary || '');
  var desc = parseDescription(event.description || '');
  var activityType = resolveActivityType(ps.sport, ps.workoutName);
  var intensity = estimateIntensity(desc);
  var st = convertEventTime(event.start && event.start.dateTime || event.start && event.start.date);
  var et = convertEventTime(event.end && event.end.dateTime || event.end && event.end.date);
  var gearKey = PARSER_TO_GEAR_KEY[activityType] || null;
  var hrTarget = null;
  var ivs = desc.intervals || [];
  for (var i = 0; i < ivs.length; i++) { if (ivs[i].hrZone && ivs[i].hrZone.low && ivs[i].hrZone.high) hrTarget = ivs[i].hrZone.low + '\u2013' + ivs[i].hrZone.high + ' bpm'; }
  var durationStr = null;
  if (desc.totalDuration) { var hrs = Math.floor(desc.totalDuration / 60), mins = desc.totalDuration % 60; durationStr = hrs > 0 ? hrs + 'h ' + mins + 'm' : mins + 'm'; }
  return {
    source:'HumanGo', activityType:activityType, gearKey:gearKey, workoutName:ps.workoutName,
    date: st.localDate, dateDisplay: st.date, startTime: st.time, startHour: st.hour,
    endTime: et.time, endHour: et.hour,
    durationMinutes: desc.totalDuration, durationStr:durationStr,
    distance: desc.totalDistance, elevation: desc.elevation,
    intensity:intensity, hrTarget:hrTarget,
    isOutdoor: ['strength','swimming'].indexOf(activityType) === -1,
    needsGearRec: ['strength','swimming'].indexOf(activityType) === -1,
    humanGoLink: desc.humanGoLink,
  };
}

// ============================================================
// WEEK'S WORKOUT DATA (test — production: Google Calendar API)
// ============================================================
var WEEK_EVENTS = [
  { id:"e1", summary:"RUNNING:Uphill Skiing-4Uphill Skiing-4",
    description:"sport: running\ntotal distance: 7.82 miles\ntotal duration: 1 hr 30 min \nElevation: climb\n\nView on HumanGo: https://redirect.humango.ai/myday?date=2026-02-08\n\n==============================\ninterval\n\nduration: 1 hr 30 min \nheart rate: \n  low: 158 bpm\n  high: 170 bpm\n\n",
    start:{dateTime:"2026-02-08T14:00:00Z"}, end:{dateTime:"2026-02-08T15:30:00Z"} },
  { id:"e2", summary:"STRENGTH:Pump Club [Z3]",
    description:"sport: strength\ntotal distance: 0.00 miles\ntotal duration: 1 hr  0 min \n\nView on HumanGo: https://redirect.humango.ai/myday?date=2026-02-09\n\n==============================\ninterval\n\nduration: 1 hr  0 min \nheart rate: \n  low: 106 bpm\n  high: 132 bpm\n\n",
    start:{dateTime:"2026-02-09T11:00:00Z"}, end:{dateTime:"2026-02-09T12:00:00Z"} },
  { id:"e3", summary:"RUNNING:12min endurance12min endurance",
    description:"sport: running\ntotal distance: 1.99 miles\ntotal duration: 32 min \n\nView on HumanGo: https://redirect.humango.ai/myday?date=2026-02-09\n\n==============================\nwarmup\n\nduration: 10 min \nheart rate: \n  low: 120 bpm\n  high: 139 bpm\n\n==============================\ninterval\n\nduration: 12 min \nheart rate: \n  low: 133 bpm\n  high: 145 bpm\n\n==============================\nrecovery\n\nduration: 2 min \nheart rate: \n  low: 95 bpm\n  high: 120 bpm\n\n==============================\ncooldown\n\nduration: 8 min \nheart rate: \n  low: 108 bpm\n  high: 139 bpm\n\n",
    start:{dateTime:"2026-02-09T22:00:00Z"}, end:{dateTime:"2026-02-09T22:32:00Z"} },
  { id:"e4", summary:"CYCLING:Endurance-3Endurance-3",
    description:"sport: cycling\ntotal distance: 9.48 miles\ntotal duration: 50 min \n\nView on HumanGo: https://redirect.humango.ai/myday?date=2026-02-10\n\n==============================\nwarmup\n\nduration: 10 min \npower: \n  low: 75 W\n  high: 98 W\n\n==============================\ninterval\n\nduration: 35 min \npower: \n  low: 83 W\n  high: 111 W\n\n==============================\ncooldown\n\nduration: 5 min \npower: \n  low: 66 W\n  high: 82 W\n\n",
    start:{dateTime:"2026-02-10T22:00:00Z"}, end:{dateTime:"2026-02-10T22:50:00Z"} },
  { id:"e5", summary:"RUNNING:Funk\u2019s Progressive thousandsFunk\u2019s Progressive thousands",
    description:"sport: running\ntotal distance: 3.30 miles\ntotal duration: 46 min 47 sec \n\nView on HumanGo: https://redirect.humango.ai/myday?date=2026-02-13\n\n==============================\nwarmup\n\nduration: 5 min \nheart rate: \n  low: 106 bpm\n  high: 132 bpm\n\n==============================\nwarmup\n\nduration: 5 min \nheart rate: \n  low: 133 bpm\n  high: 145 bpm\n\n==============================\ninterval\n\ndistance: 0.62 miles\nheart rate: \n  low: 142 bpm\n  high: 149 bpm\n\n==============================\nrecovery\n\nduration: 2 min \nheart rate: \n  low: 106 bpm\n  high: 132 bpm\n\n==============================\ninterval\n\ndistance: 0.62 miles\nheart rate: \n  low: 149 bpm\n  high: 156 bpm\n\n==============================\nrecovery\n\nduration: 2 min \nheart rate: \n  low: 106 bpm\n  high: 132 bpm\n\n==============================\ninterval\n\ndistance: 0.62 miles\nheart rate: \n  low: 156 bpm\n  high: 164 bpm\n\n==============================\nrecovery\n\nduration: 2 min \nheart rate: \n  low: 106 bpm\n  high: 132 bpm\n\n==============================\ncooldown\n\nduration: 3 min \nheart rate: \n  low: 133 bpm\n  high: 145 bpm\n\n==============================\ncooldown\n\nduration: 5 min \nheart rate: \n  low: 106 bpm\n  high: 132 bpm\n\n",
    start:{dateTime:"2026-02-13T22:00:00Z"}, end:{dateTime:"2026-02-13T22:46:47Z"} }
];
var ALL_WORKOUTS = WEEK_EVENTS.map(function(e) { return parseWorkoutEvent(e); });
function getWorkoutForDate(ds) { return ALL_WORKOUTS.filter(function(w) { return w.date === ds && w.needsGearRec; })[0] || null; }
function hasWorkout(ds) { return ALL_WORKOUTS.some(function(w) { return w.date === ds; }); }

// ============================================================
// GEAR INVENTORY (Google Sheet with fallback)
// ============================================================
var GEAR_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0IplF973EGbOjyvV5KNaFAjd10upUQwfsWc_4c1yVzJZxrtqe4gKwsfK6ZL0UZfNnyhcq_JOX9FLT/pub?gid=813539961&single=true&output=csv';
var GEAR_FALLBACK = [
  { id:"boot-xc", brand:"Rossignol", model:"BC X5 FW", zone:"feet", activities:["xc-ski","uphill-ski"], tempMin:-15, tempMax:30, wind:.80, water:.55, breathe:.40, insulated:true },
  { id:"pants-1", brand:"Swix", model:"Cross Pants W", zone:"legs", activities:["xc-ski","uphill-ski","hike","snowshoe"], tempMin:5, tempMax:35, wind:.75, water:.30, breathe:.70, insulated:false },
  { id:"vest-1", brand:"Swix", model:"Horizon PrimaLoft Vest", zone:"torso-mid", activities:["xc-ski","uphill-ski","hike","run-road","run-trail","snowshoe","road-bike","mtb","fat-bike","stud-bike"], tempMin:0, tempMax:35, wind:.85, water:.50, breathe:.50, insulated:true },
  { id:"base-1", brand:"REI Co-op", model:"Midweight Half-Zip", zone:"torso-base", activities:["all"], tempMin:10, tempMax:45, wind:.15, water:.05, breathe:.85, insulated:false },
  { id:"hat-1", brand:"Smartwool", model:"Ear Flap 5 Panel Hat", zone:"head", activities:["xc-ski","uphill-ski","hike","run-road","run-trail","snowshoe","road-bike","mtb","fat-bike","stud-bike"], tempMin:10, tempMax:45, wind:.50, water:.20, breathe:.75, insulated:false },
  { id:"buff-1", brand:"Buff", model:"Original", zone:"neck", activities:["all"], tempMin:15, tempMax:60, wind:.30, water:.05, breathe:.90, insulated:false },
  { id:"gloves-1", brand:"Pearl Izumi", model:"AmFIB Lite Gloves", zone:"hands", activities:["xc-ski","uphill-ski","hike","run-road","run-trail","snowshoe","road-bike","mtb","fat-bike","stud-bike"], tempMin:5, tempMax:45, wind:.80, water:.40, breathe:.55, insulated:true },
  { id:"shell-1", brand:"REI Co-op", model:"Swiftland H2O Jacket", zone:"torso-shell", activities:["xc-ski","uphill-ski","hike","run-road","run-trail","snowshoe","road-bike","mtb","fat-bike","stud-bike"], tempMin:10, tempMax:65, wind:.95, water:.90, breathe:.55, insulated:false, isShell:true }
];
var GEAR = GEAR_FALLBACK;
var gearSource = 'fallback';
var gearError = '';

function parseCSV(text) {
  var rows = [], row = [], cell = '', inQuotes = false;
  for (var i = 0; i < text.length; i++) {
    var ch = text[i], next = text[i+1] || '';
    if (inQuotes) {
      if (ch === '"' && next === '"') { cell += '"'; i++; }
      else if (ch === '"') inQuotes = false;
      else cell += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { row.push(cell.trim()); cell = ''; }
      else if (ch === '\n' || (ch === '\r' && next === '\n')) {
        row.push(cell.trim()); cell = '';
        if (row.length > 1) rows.push(row);
        row = [];
        if (ch === '\r') i++;
      } else cell += ch;
    }
  }
  if (cell || row.length) { row.push(cell.trim()); if (row.length > 1) rows.push(row); }
  return rows;
}

function toBool(v) { var s = (v||'').toString().toLowerCase(); return s === 'true' || s === 'yes' || s === '1'; }

function csvToGear(rows) {
  if (rows.length < 2) return null;
  var headers = rows[0].map(function(h) { return h.toLowerCase().trim(); });
  var findCol = function(name) {
    for (var i = 0; i < headers.length; i++) { if (headers[i].indexOf(name) !== -1) return i; }
    return -1;
  };
  var cId = findCol('id'), cBrand = findCol('brand'), cModel = findCol('model'), cZone = findCol('zone');
  var cActs = findCol('activities'), cTmin = findCol('temp min'), cTmax = findCol('temp max');
  var cWind = findCol('wind'), cWater = findCol('water'), cBreathe = findCol('breathe');
  var cIns = findCol('insulated'), cShell = findCol('shell');
  var gear = [];
  for (var i = 1; i < rows.length; i++) {
    var r = rows[i];
    if (!r[cBrand] && !r[cModel]) continue;
    var acts = (r[cActs] || '').split(',').map(function(a) { return a.trim(); }).filter(Boolean);
    gear.push({
      id: (r[cId] || 'gear-'+i).trim(),
      brand: (r[cBrand] || '').trim(),
      model: (r[cModel] || '').trim(),
      zone: (r[cZone] || '').trim(),
      activities: acts,
      tempMin: parseFloat(r[cTmin]) || 0,
      tempMax: parseFloat(r[cTmax]) || 50,
      wind: parseFloat(r[cWind]) || 0,
      water: parseFloat(r[cWater]) || 0,
      breathe: parseFloat(r[cBreathe]) || 0.5,
      insulated: toBool(r[cIns]),
      isShell: toBool(r[cShell]),
    });
  }
  return gear.length > 0 ? gear : null;
}

async function fetchGear() {
  try {
    var resp = await fetch(GEAR_SHEET_URL);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    var text = await resp.text();
    if (text.indexOf('<!DOCTYPE') !== -1) throw new Error('Got HTML instead of CSV — check sharing settings');
    var rows = parseCSV(text);
    var gear = csvToGear(rows);
    if (gear) { GEAR = gear; gearSource = 'sheet'; console.log('Loaded ' + gear.length + ' items from Google Sheet'); return; }
    throw new Error('No valid gear rows');
  } catch(e) {
    console.warn('Gear Sheet fetch failed, using fallback:', e.message);
    GEAR = GEAR_FALLBACK; gearSource = 'fallback';
    gearError = e.message;
  }
}

// ============================================================
// ACTIVITIES
// ============================================================
var ACTS = {
  "xc-ski":       { name:"Cross-Country Ski", emoji:"\u26f7\ufe0f",  group:"Skiing", tempAdj:-8,  breatheNeed:.7, windNeed:.6, waterNeed:.3, intensity:"high" },
  "uphill-ski":   { name:"Uphill Ski",        emoji:"\u26f7\ufe0f",  group:"Skiing", tempAdj:-10, breatheNeed:.8, windNeed:.5, waterNeed:.3, intensity:"high" },
  "downhill-ski": { name:"Downhill Ski",      emoji:"\ud83c\udfbf",  group:"Skiing", tempAdj:-2,  breatheNeed:.3, windNeed:.9, waterNeed:.5, intensity:"low" },
  "road-bike":    { name:"Road Cycling",      emoji:"\ud83d\udeb4",  group:"Cycling", tempAdj:-10, breatheNeed:.8, windNeed:.7, waterNeed:.3, intensity:"high" },
  "mtb":          { name:"Mountain Biking",   emoji:"\ud83d\udeb5",  group:"Cycling", tempAdj:-8,  breatheNeed:.8, windNeed:.5, waterNeed:.4, intensity:"high" },
  "fat-bike":     { name:"Fat Biking",        emoji:"\ud83d\udeb2",  group:"Cycling", tempAdj:-4,  breatheNeed:.6, windNeed:.7, waterNeed:.4, intensity:"moderate", note:"Dress warmer than effort suggests" },
  "stud-bike":    { name:"Stud Biking",       emoji:"\ud83d\udeb2",  group:"Cycling", tempAdj:-4,  breatheNeed:.6, windNeed:.7, waterNeed:.4, intensity:"moderate" },
  "run-road":     { name:"Road Running",      emoji:"\ud83c\udfc3\u200d\u2640\ufe0f", group:"Running", tempAdj:-12, breatheNeed:.9, windNeed:.4, waterNeed:.2, intensity:"very high" },
  "run-trail":    { name:"Trail Running",     emoji:"\ud83c\udfc3\u200d\u2640\ufe0f", group:"Running", tempAdj:-10, breatheNeed:.85, windNeed:.4, waterNeed:.3, intensity:"high" },
  "hike":         { name:"Hiking",            emoji:"\ud83e\udd7e",  group:"Other", tempAdj:-5,  breatheNeed:.5, windNeed:.6, waterNeed:.5, intensity:"moderate" },
  "snowshoe":     { name:"Snowshoeing",       emoji:"\ud83c\udfd4\ufe0f",  group:"Other", tempAdj:-6,  breatheNeed:.6, windNeed:.6, waterNeed:.4, intensity:"moderate" },
  "dog-walk":     { name:"Dog Walking",       emoji:"\ud83d\udc15",  group:"Other", tempAdj:-2,  breatheNeed:.3, windNeed:.5, waterNeed:.4, intensity:"low" },
  "snowmobile":   { name:"Snowmobile",        emoji:"\ud83c\udfc2",  group:"Motor", tempAdj:2,   breatheNeed:.2, windNeed:.95, waterNeed:.5, intensity:"low", note:"High wind chill \u2014 dress very warm" },
  "dirtbike":     { name:"Dirt Bike / Moto",  emoji:"\ud83c\udfcd\ufe0f",  group:"Motor", tempAdj:2,   breatheNeed:.2, windNeed:.95, waterNeed:.4, intensity:"low", note:"High wind chill \u2014 dress very warm" },
};
var ZONE_CONFIG = {
  "head":        { icon:"\ud83e\udde2", label:"Head",      required:["xc-ski","uphill-ski","downhill-ski","hike","snowshoe","run-road","run-trail","fat-bike","stud-bike","snowmobile"], generic:"Beanie or warm cap" },
  "neck":        { icon:"\ud83e\udde3", label:"Neck",      required:["downhill-ski","snowmobile","dirtbike"], generic:"Buff or neck gaiter" },
  "torso-base":  { icon:"\ud83d\udc55", label:"Base Layer", required:["xc-ski","uphill-ski","downhill-ski","hike","snowshoe","run-road","run-trail","road-bike","mtb","fat-bike","stud-bike","snowmobile","dirtbike","dog-walk"], generic:"Moisture-wicking base layer" },
  "torso-mid":   { icon:"\ud83e\uddba", label:"Mid Layer", required:["xc-ski","uphill-ski","downhill-ski","snowshoe","snowmobile","dirtbike"], generic:"Fleece or insulated vest" },
  "torso-shell": { icon:"\ud83e\udde5", label:"Shell",     required:[], generic:"Wind/rain shell" },
  "hands":       { icon:"\ud83e\udde4", label:"Gloves",    required:["xc-ski","uphill-ski","downhill-ski","snowshoe","fat-bike
